<!DOCTYPE html>
<html>
  <head>
    <title>Load data file</title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
  </head>
  <body>
  	<div id="container" style="width:100%;">                                   
		<div id="left_req_body" style="float:left; width:50%;">  
			<h1>  Load fitness member data file (csv, xml, json) </h3>
			<form name="externalData" id="">
				<p><input type="button" class="button" id="loadBtn" value="Import file" onclick="document.getElementById('fileDialog').click();"></p>
				<input id="fileDialog" type="file" style="display:none;" nwworkingdir="./" accept=".json, .csv" />
				<%/*  
				<p>Converted JSON file content:</p>
				<textarea id="fileContents" style="width:700px;height:300px;"></textarea>
				*/%>
			</form>
			<%/* 
			<form name="submitFrm" id="">
				<p><input type="button" class="button" id="submitBtn" value="Upload"></p>	
			</form>
			*/%>
		</div>
	</div>
</html>

<script>
	
	function loadFile(fileName) {
		var chooser = document.getElementById('fileDialog');
	    chooser.addEventListener("change", function(evt) {
	    		var file = document.getElementById("fileDialog").files[0];
	    		if (file) {
	    			readData(file);
	    		}
	    }, false);
	    chooser.click();
	}
	loadFile();
	
	function readData(file){
		var fileName = file.name;
		var reader = new FileReader();
		var jsonObj = {};
	    reader.readAsText(file, "UTF-8");
	    reader.onload = function (evt) {
    		try {
    			if (fileName.endsWith('csv')){
    				jsonObj = JSON.parse(csvJSON(evt.target.result));
    			} else { //JSON
    				jsonObj = JSON.parse(evt.target.result);
    			}
				console.log('successfully read file ' + fileName + '\n' + 'Now will validate it.');
				validJson = validateJson(jsonObj);
 				//document.getElementById('fileContents').innerHTML = JSON.stringify(validJson);
 				submitForm(JSON.stringify(validJson), fileName);
			} catch (err) {
				console.log('unable to read json file: ' + err.stack);
				
			}	    		    		
	    }
	}
	
	function validateJson(jsonObj){
		for (var i in jsonObj){
			var s = jsonObj[i]['Date'];
			if (s.indexOf('/') != -1){
				jsonObj[i]['Date'] = formatDate(new Date(s));
			}
		}
		console.log('validated json object: ' + JSON.stringify(jsonObj, null, 2));
		return jsonObj;
	}
	
	function formatDate(date) {
	    var d = new Date(date),
	        month = '' + (d.getMonth() + 1),
	        day = '' + d.getDate(),
	        year = d.getFullYear();

	    if (month.length < 2) month = '0' + month;
	    if (day.length < 2) day = '0' + day;

	    return [year, month, day].join('-');
	}
	
	function csvJSON(csv){
	  var lines=csv.split("\n");
	  var result = [];
	  var headers=lines[0].split(",");
	  for(var i=1;i<lines.length;i++){
		  var obj = {};
		  var currentline=lines[i].split(",");
		  for(var j=0;j<headers.length;j++){
			  obj[headers[j]] = currentline[j];
		  }
		  result.push(obj);
	  }
	  console.log('current result = ' + JSON.stringify(result));
	  return JSON.stringify(result); 
	}
		
// 	function composeAPICall(){
// 		submitBtn.addEventListener("click", function(evt) {
// 		var req_body = document.getElementById('fileContents').value;
// 		submitForm(req_body);	
// 		}, false);
// 	}
// 	composeAPICall();
	

	function submitForm(req_body, fileName){
		var date = new Date();
		var date_prefix = date.getFullYear() + ("0" + (date.getMonth() + 1)).slice(-2) + ("0" + date.getDate()).slice(-2)
		 + ("0" + date.getHours()).slice(-2) + ("0" + date.getMinutes()).slice(-2);
		var random = Math.floor(Math.random() * (100000 - 1)) + 1;

		var baseURL = window.location.origin;
		path = baseURL + "/dataRecord/" + date_prefix + fileName + random ; 
		
		var form = document.createElement("form");
		form.setAttribute("method", "post");
		form.setAttribute("action", path);
		
		var hiddenField = document.createElement("input");
		hiddenField.setAttribute("type", "hidden");
		hiddenField.setAttribute("name", "JSONbody");
		hiddenField.setAttribute("value", req_body);
		form.appendChild(hiddenField);
		document.body.appendChild(form);
		form.submit();
	}

</script>